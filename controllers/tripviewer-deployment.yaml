apiVersion: v1
kind: Service
metadata:
  name: tripviewer
spec:
  # Expose the service on a static port on each node
  # so that we can access the service from outside the cluster
  type: LoadBalancer

  # When the node receives a request on the static port (30163)
  # "select pods with the label 'app' set to 'echo-hostname'"
  # and forward the request to one of them
  selector:
    app: tripviewer

  ports:
    # Three types of ports for a service
    # nodePort - a static port assigned on each the node.  Access service via this external port number
    # port - port exposed internally in the cluster
    # targetPort - the container port to send requests to
    - port: 80
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  #A Deployment named tripviewer-deployment is created, indicated by the .metadata.name field.
  name: tripviewer
spec:
  replicas: 1
  #The .spec.selector field defines how the Deployment finds which Pods to manage.
  selector:
    matchLabels:
      app: tripviewer
  #The template field contains the following sub-fields:
  #The Pods are labeled app: tripviewer using the .metadata.labels field.
  template:
    metadata:
      labels:
        app: tripviewer
    spec:
      containers:
        - name: tripviewer
          image: registryofy4959.azurecr.io/tripinsights/tripviewer:1.0
          ports:
            - containerPort: 80
          envFrom:
            - secretRef:
                name: trip-secrets
            - configMapRef:
                name: trip-configs
          resources:
            requests:
              cpu: 250m
              memory: 64Mi
            limits:
              cpu: 500m
              memory: 256Mi
